"use strict";var Quadtree=function(t,i){this.box=t,this.children=null,this.value=[],this.max=i||10};Quadtree.prototype.insert=function(t,i){if(!this.box.contains(t))return this;var e;if(null===this.children&&this.value.length<this.max){for(e=0;e<this.value.length;e++)if(this.value[e].point.equals(t))return void(this.value[e].value=i);return this.value.push({point:t,value:i}),this}for(null===this.children&&this.subdivide(),e=0;e<this.children.length;e++)this.children[e].insert(t,i);return this.value=[],this},Quadtree.prototype.subdivide=function(){this.children=this.box.split();for(var t=0;t<this.children.length;t++)this.children[t]=new Quadtree(this.children[t],this.max);for(t=0;t<this.value.length;t++)for(var i=0;i<this.children.length;i++)this.children[i].insert(this.value[t].point,this.value[t].value)},Quadtree.prototype.queryRange=function(t){var i=[];return this._queryRangeRec(t,i),i},Quadtree.prototype._queryRangeRec=function(t,i){if(this.box.overlaps(t)){var e;if(this.value.length>0)for(e=0;e<this.value.length;e++)t.contains(this.value[e].point)&&i.push(this.value[e]);else if(null===this.children);else for(e=0;e<this.children.length;e++)this.children[e]._queryRangeRec(t,i)}},Quadtree.prototype.queryPoint=function(t){if(!this.box.contains(t))return null;if(this.value.length>0)for(var i=0;i<this.value.length;i++)if(this.value[i].point.equals(t))return this.value[i].value;if(null!==this.children){for(var e=null,i=0;i<this.children.length;i++)e=e||this.children[i].queryPoint(t);return e}return null},Quadtree.prototype.removePoint=function(t){if(this.box.contains(t)){var i;if(this.value.length>0){for(i=0;i<this.value.length;i++)if(this.value[i].point.equals(t))return void this.value.splice(i,1)}else if(null!==this.children)for(i=0;i<this.children.length;i++)this.children[i].removePoint(t)}},Quadtree.prototype.clear=function(){this.children=null,this.value=[]};var Box=function(t,i){this.low=t,this.high=i};Box.prototype.contains=function(t){return this.low.lte(t)&&this.high.gte(t)?!0:!1},Box.prototype.overlaps=function(t){return this.contains(t.low)||this.contains(t.high)||t.contains(this.low)||t.contains(this.high)?!0:!1},Box.prototype.split=function(){var t=[];return t.push(new Box(this.low,new Point((this.low.x+this.high.x)/2,(this.low.y+this.high.y)/2))),t.push(new Box(new Point((this.low.x+this.high.x)/2,this.low.y),new Point(this.high.x,(this.low.y+this.high.y)/2))),t.push(new Box(new Point((this.low.x+this.high.x)/2,(this.low.y+this.high.y)/2),this.high)),t.push(new Box(new Point(this.low.x,(this.low.y+this.high.y)/2),new Point((this.low.x+this.high.x)/2,this.high.y))),t};var Point=function(t,i){this.x=t,this.y=i};Point.prototype.lte=function(t){return this.x<=t.x&&this.y<=t.y?!0:!1},Point.prototype.gte=function(t){return this.x>=t.x&&this.y>=t.y?!0:!1},Point.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},"undefined"!=typeof module&&(module.exports.Quadtree=Quadtree,module.exports.Box=Box,module.exports.Point=Point);var Vector=function(t,i){this.top=i||0,this.left=t||0};Vector.prototype.add=function(){for(var t=this.top,i=this.left,e=0;e<arguments.length;e++)t+=arguments[e].top,i+=arguments[e].left;return new Vector(i,t)},Vector.prototype.sub=function(){for(var t=this.top,i=this.left,e=0;e<arguments.length;e++)t-=arguments[e].top,i-=arguments[e].left;return new Vector(i,t)},Vector.prototype.distance=function(t){return Math.sqrt(Math.pow(this.left-t.left,2)+Math.pow(this.top-t.top,2))},Vector.prototype.multiplyScalar=function(t){return this.top*=t,this.left*=t,this},Vector.prototype.magnitude=function(){return this.distance(this.origin)},Vector.prototype.unitVector=function(t){t=t||1;var i=this.magnitude()||1;return new Vector(this.left*t/i,this.top*t/i)},Vector.prototype.origin=new Vector(0,0);var Swarm=function(t,i,e,o,n){this.population=t||[],this.quadtree=new Quadtree(new Box(new Point(i,e),new Point(i+o,e+n)))};Swarm.prototype.tick=function(){var t,i,e;for(t=0;t<this.population.length;t++)e=this.population[t],i=new Point(e.position.left,e.position.top),this.quadtree.insert(i,e);var o=this;for(t=0;t<this.population.length;t++)this.population[t].calculateNextAcceleration(function(t,i,e){for(var n=new Box(new Point(i.left-t,i.top-t),new Point(i.left+t,i.top+t)),h=o.quadtree.queryRange(n),r=[],s=0;s<h.length;s++)-1!==e.indexOf(h[s].value.type)&&r.push(h[s].value);return r});for(t=0;t<this.population.length;t++)this.population[t].update();this.quadtree.clear()},Swarm.prototype.forEach=function(t){for(var i=0;i<this.population.length;i++)t(this.population[i])};var Agent=function(t){this.type=t.type||"default",this.forces=t.forces||{},this.position=t.position||new Vector(0,0),this.velocity=t.velocity||new Vector(0,0),this.acceleration=t.acceleration||new Vector(0,0),this.velocityLimit=t.velocityLimit||2,this.accelerationLimit=t.accelerationLimit||.3,this.nextAcceleration=new Vector(0,0)};Agent.prototype.update=function(){this.updatePosition(),this.updateVelocity(),this.updateAcceleration()},Agent.prototype.updateVelocity=function(){this.velocity=this.velocity.add(this.acceleration),this.velocity.magnitude()>this.velocityLimit&&(this.velocity=this.velocity.unitVector(this.velocityLimit))},Agent.prototype.updatePosition=function(){this.position=this.position.add(this.velocity)},Agent.prototype.updateAcceleration=function(){this.acceleration=this.nextAcceleration,this.acceleration.magnitude()>this.accelerationLimit&&(this.acceleration=this.acceleration.unitVector(this.accelerationLimit))},Agent.prototype.calculateNextAcceleration=function(t){for(var i,e=new Vector(0,0),o=this,n=0;n<this.forces.length;n++)this.forces[n].areaOfEffect&&(i=t(this.forces[n].areaOfEffect,this.position,this.forces[n].causes)),e=e.add(this.forces[n].calculate(o,i).multiplyScalar(this.forces[n].strength));this.nextAcceleration=this.acceleration.add(e),this.nextAcceleration.magnitude()>this.accelerationLimit&&this.nextAcceleration.unitVector(this.accelerationLimit)};
